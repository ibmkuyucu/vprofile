# MySQL Setup
vagrant ssh db01

for host in $(sed '/^#/d' /etc/hosts | sed '/^[[:space:]]*$/d' | tail -n 5 | awk '{print $2}'); do ping -c 3 "$host"; done

# sudo yum update -y

sudo yum install -y epel-release
sudo yum install -y git mariadb-server

sudo systemctl start mariadb
sudo systemctl enable mariadb

sudo mysql_secure_installation

mysql -u root -padmin123

create database accounts;
grant all privileges on accounts.* TO 'admin'@'%' identified by 'admin123';
FLUSH PRIVILEGES;
exit;

# git clone -b main https://github.com/ibmkuyucu/vprofile.git
# cd vprofile
mysql -u root -padmin123 accounts < /vagrant/db_backup.sql
mysql -u root -padmin123 accounts

show tables;
exit;

sudo systemctl restart mariadb

sudo systemctl start firewalld
sudo systemctl enable firewalld
sudo firewall-cmd --zone=public --add-port=3306/tcp --permanent
sudo firewall-cmd --reload

exit

# Memcache Setup
vagrant ssh mc01

for host in $(sed '/^#/d' /etc/hosts | sed '/^[[:space:]]*$/d' | tail -n 5 | awk '{print $2}'); do ping -c 3 "$host"; done

# sudo dnf update -y

sudo dnf install epel-release -y
sudo dnf install memcached -y
sudo sed -i 's/127.0.0.1/0.0.0.0/g' /etc/sysconfig/memcached
sudo systemctl start memcached
sudo systemctl enable memcached

sudo systemctl start firewalld
sudo systemctl enable firewalld
sudo firewall-cmd --add-port=11211/tcp
sudo firewall-cmd --add-port=11111/udp
sudo firewall-cmd --runtime-to-permanent
sudo memcached -p 11211 -U 11111 -u memcached -d

exit

# RabbitMQ Setup
vagrant ssh rmq01

for host in $(sed '/^#/d' /etc/hosts | sed '/^[[:space:]]*$/d' | tail -n 5 | awk '{print $2}'); do ping -c 3 "$host"; done

# sudo yum update -y

sudo yum install -y epel-release
sudo yum install -y wget
sudo yum install -y centos-release-rabbitmq-38
sudo yum --enablerepo=centos-rabbitmq-38 install -y rabbitmq-server

sudo systemctl enable --now rabbitmq-server

sudo sh -c 'echo "[{rabbit, [{loopback_users, []}]}]." > /etc/rabbitmq/rabbitmq.config'
sudo rabbitmqctl add_user test test
sudo rabbitmqctl set_user_tags test administrator
sudo systemctl restart rabbitmq-server

sudo systemctl start firewalld
sudo systemctl enable firewalld
sudo firewall-cmd --add-port=5672/tcp
sudo firewall-cmd --runtime-to-permanent

exit

# Tomcat Setup
vagrant ssh app01

for host in $(sed '/^#/d' /etc/hosts | sed '/^[[:space:]]*$/d' | tail -n 5 | awk '{print $2}'); do ping -c 3 "$host"; done

# sudo yum update -y

sudo yum install -y epel-release
sudo yum install -y java-11-openjdk java-11-openjdk-devel
sudo yum install -y git maven wget vim

cd /tmp/
wget https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.75/bin/apache-tomcat-9.0.75.tar.gz
tar xzvf apache-tomcat-9.0.75.tar.gz
sudo useradd --home-dir /usr/local/tomcat --shell /sbin/nologin tomcat
sudo cp -r /tmp/apache-tomcat-9.0.75/* /usr/local/tomcat/
sudo chown -R tomcat.tomcat /usr/local/tomcat

sudo vim /etc/systemd/system/tomcat.service

[Unit]
Description=Tomcat
After=network.target

[Service]
User=tomcat
WorkingDirectory=/usr/local/tomcat
Environment=JRE_HOME=/usr/lib/jvm/jre
Environment=JAVA_HOME=/usr/lib/jvm/jre
Environment=CATALINA_HOME=/usr/local/tomcat
Environment=CATALINE_BASE=/usr/local/tomcat
ExecStart=/usr/local/tomcat/bin/catalina.sh run
ExecStop=/usr/local/tomcat/bin/shutdown.sh
SyslogIdentifier=tomcat-%i

[Install]
WantedBy=multi-user.target

sudo systemctl daemon-reload
sudo systemctl start tomcat
sudo systemctl enable tomcat

sudo systemctl start firewalld
sudo systemctl enable firewalld
sudo firewall-cmd --zone=public --add-port=8080/tcp --permanent
sudo firewall-cmd --reload

# Code Build & Deploy
git clone -b main https://github.com/ibmkuyucu/vprofile.git
cd vprofile
vim src/main/resources/application.properties

mvn install
sudo systemctl stop tomcat

sudo rm -rf /usr/local/tomcat/webapps/ROOT
sudo rm -rf /usr/local/tomcat/webapps/ROOT.war
sudo cp target/vprofile-v2.war /usr/local/tomcat/webapps/ROOT.war
sudo chown tomcat.tomcat /usr/local/tomcat/webapps -R
sudo systemctl start tomcat

exit

# Nginx Setup
vagrant ssh web01

for host in $(sed '/^#/d' /etc/hosts | sed '/^[[:space:]]*$/d' | tail -n 5 | awk '{print $2}'); do ping -c 3 "$host"; done

sudo apt update && sudo apt install -y vim nginx

sudo vim /etc/nginx/sites-available/vproapp

upstream vproapp {
    server app01:8080;
}
server {
    listen 80;
    location / {
        proxy_pass http://vproapp;
    }
}

sudo rm -rf /etc/nginx/sites-enabled/default
sudo ln -s /etc/nginx/sites-available/vproapp /etc/nginx/sites-enabled/vproapp

sudo systemctl restart nginx